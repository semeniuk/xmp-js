"use strict";function _classCallCheck(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,r){for(var n=0;n<r.length;n++){var t=r[n];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(e,t.key,t)}}function _createClass(e,r,n){return r&&_defineProperties(e.prototype,r),n&&_defineProperties(e,n),e}var XMP=function(){function e(r){_classCallCheck(this,e),this.buffer=null,r instanceof ArrayBuffer?this.buffer=r:("string"==typeof r||r instanceof String)&&this.fromDataUri(r)}return _createClass(e,[{key:"fromDataUri",value:function(r){this.buffer=e.dataUriToBuffer(r)}},{key:"find",value:function(){return e.find(this.buffer)}},{key:"parse",value:function(){var r=this.find();return e.parse(r)}}],[{key:"dataUriToBuffer",value:function(e){for(var r=atob(e.split(",")[1]),n=r.length,t=new ArrayBuffer(n),a=new Uint8Array(t),f=0;f<n;f++)a[f]=r.charCodeAt(f);return t}},{key:"find",value:function(r){var n;r instanceof ArrayBuffer?n=r:("string"==typeof r||r instanceof String)&&(n=e.dataUriToBuffer(r));var t=new DataView(n);if(65496!==t.getUint16(0,!1))return console.warn("not valid JPEG"),null;for(var a="<x:xmpmeta".length,f=n.byteLength-a,i="x:xmpmeta>".length,o=n.byteLength-i,u=2,s=u+a,c=!1;u<f;){if("<x:xmpmeta"==e.stringFromBuffer(t,u,a)){c=!0;break}u++}if(!c)return console.warn("XMP not found"),null;for(;s<o&&"x:xmpmeta>"!=e.stringFromBuffer(t,s,i);)s++;return s+=i,e.stringFromBuffer(t,u,s-u)}},{key:"stringFromBuffer",value:function(e,r,n){for(var t="",a=r;a<r+n;a++)t+=String.fromCharCode(e.getUint8(a));return t}},{key:"parse",value:function(e){if(!e)return null;var r={};return["title","description","rights","creator","subject"].forEach((function(n){var t=new RegExp("<dc:".concat(n,">(.*?)</dc:").concat(n,">"),"smig").exec(e);if(t&&0!==t.length){var a=t[1].trim();if(0===a.toLowerCase().indexOf("<rdf:bag>")){for(var f=new RegExp("<rdf:li>(.*?)</rdf:li>","smig"),i=f.exec(a),o=[];i;)o.push(i[1]),i=f.exec(a);r[n]=o}else r[n]=a.replace(/<[^>]*>?/gm,"").trim()}})),r}}]),e}();module.exports=XMP;
